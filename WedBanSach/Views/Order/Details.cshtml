@model WedBanSach.Models.Order
@{
    ViewData["Title"] = $"Chi tiết đơn hàng #{Model.OrderID}";
}

<style>
    :root {
        --pink-main: #f8cdda;
        --pink-light: #fde7f0;
        --pink-hover: #f5b0c4;
        --white: #ffffff;
        --text-dark: #444444;
        --border-soft: #f1c6d9;
    }
    
    .sidebar-menu .nav-link {
        color: var(--text-dark);
        border-radius: 10px;
        padding: 12px 20px;
        margin-bottom: 5px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        text-decoration: none;
    }
    
    .sidebar-menu .nav-link:hover {
        background-color: var(--pink-light);
        color: #C92127;
    }
    
    .sidebar-menu .nav-link.active {
        background-color: var(--pink-main);
        color: #C92127;
        font-weight: 600;
    }
    
    .step-progress {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }
    
    .step-progress::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: #f0f0f0;
        z-index: 1;
    }
    
    .step-item {
        position: relative;
        z-index: 2;
        text-align: center;
        width: 25%;
    }
    
    .step-icon {
        width: 32px;
        height: 32px;
        background-color: #f0f0f0;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #999;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .step-item.active .step-icon {
        background-color: #2dc258;
        color: white;
    }

    .step-item.completed .step-icon {
        background-color: #2dc258;
        color: white;
    }
     /* Line Color Logic - simplified strictly for 4 steps */
     /* This would be better with JS or tailored CSS but using basic class for now */
</style>

<div class="container py-5">
    @{ ViewData["ActivePage"] = "History"; }
    <div class="row">
        <!-- Sidebar -->
        <partial name="_AccountSidebar" />
        
        <!-- Content -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <a asp-controller="Order" asp-action="History" class="text-secondary text-decoration-none small"><i class="bi bi-chevron-left"></i> Quay lại</a>
                        <h5 class="fw-bold m-0 mt-1">Chi tiết đơn hàng #@Model.OrderID</h5>
                    </div>
                    <span class="text-muted small">Ngày đặt: @Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
                
                <div class="card-body p-4">
                    <!-- Progress Tracker (Simplified) -->
                    @{
                        // Status Logic
                        bool isPending = Model.OrderStatus == "Pending";
                        bool isShipping = Model.OrderStatus == "Shipping" || Model.OrderStatus == "Đang giao";
                        bool isCompleted = Model.OrderStatus == "Completed" || Model.OrderStatus == "Hoàn tất";
                        bool isCancelled = Model.OrderStatus == "Cancelled" || Model.OrderStatus == "Đã hủy";
                    }
                    
                    @if(!isCancelled) {
                        <div class="step-progress mb-5">
                            <div class="step-item active">
                                <div class="step-icon"><i class="bi bi-receipt"></i></div>
                                <small class="d-block fw-bold">Đặt hàng</small>
                                <small class="text-muted">@Model.OrderDate.ToString("HH:mm dd/MM")</small>
                            </div>
                            <div class="step-item @(isShipping || isCompleted ? "active" : "")">
                                <div class="step-icon"><i class="bi bi-box-seam"></i></div>
                                <small class="d-block fw-bold">Đang giao</small>
                            </div>
                            <div class="step-item @(isCompleted ? "active" : "")">
                                <div class="step-icon"><i class="bi bi-check-lg"></i></div>
                                <small class="d-block fw-bold">Hoàn tất</small>
                            </div>
                        </div>
                    } else {
                        <div class="alert alert-danger text-center mb-4">
                            <i class="bi bi-x-circle-fill me-2"></i> Đơn hàng này đã bị hủy.
                        </div>
                    }

                    <!-- Address & Payment -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="bg-light p-3 rounded-3 h-100">
                                <h6 class="fw-bold text-dark mb-3">Địa chỉ nhận hàng</h6>
                                <p class="mb-1 text-dark">@Model.ShippingAddress</p>
                                <div class="text-muted small mt-2">
                                    Đơn vị vận chuyển: <span class="text-dark fw-bold">Standard Shipping</span><br>
                                    Phí vận chuyển: <span class="text-dark fw-bold">@((Model.ShippingFee ?? 0).ToString("#,##0")) đ</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-light p-3 rounded-3 h-100">
                                <h6 class="fw-bold text-dark mb-3">Thanh toán</h6>
                                <p class="mb-1 text-dark">Phương thức: <span class="fw-bold">@Model.PaymentMethod</span></p>
                                <p class="mb-0 text-dark">Trạng thái: 
                                    @if(Model.Payments != null && Model.Payments.Any(p => p.PaymentStatus == "Paid")) {
                                        <span class="text-success fw-bold">Đã thanh toán</span>
                                    } else {
                                        <span class="text-warning fw-bold">Chưa thanh toán</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Products -->
                    <h6 class="fw-bold mb-3 border-bottom pb-2">Sản phẩm</h6>
                    <div class="mb-4">
                        @foreach (var detail in Model.OrderDetails)
                        {
                            <div class="d-flex gap-3 mb-3 border-bottom pb-3">
                                <img src="@(detail.Book?.BookImages?.FirstOrDefault(i => i.IsMain)?.ImageUrl ?? "/images/default-book.png")" 
                                     class="rounded border" style="width: 70px; height: 90px; object-fit: contain;">
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1">@detail.Book?.Title</h6>
                                    <small class="text-muted">Đơn giá: @((detail.UnitPrice ?? 0).ToString("#,##0")) đ</small>
                                    <div class="d-flex justify-content-between align-items-end mt-2">
                                        <span class="small border px-2 py-1 rounded">x @detail.Quantity</span>
                                        <span class="fw-bold text-dark">@((detail.Quantity * (detail.UnitPrice ?? 0)).ToString("#,##0")) đ</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Summary -->
                     <div class="d-flex flex-column align-items-end">
                        <div class="d-flex justify-content-between w-100 mb-2" style="max-width: 300px;">
                            <span class="text-muted">Tổng tiền hàng</span>
                            <span>@(((Model.TotalAmount ?? 0) - (Model.ShippingFee ?? 0)).ToString("#,##0")) đ</span>
                        </div>
                        <div class="d-flex justify-content-between w-100 mb-2" style="max-width: 300px;">
                            <span class="text-muted">Phí vận chuyển</span>
                            <span>@((Model.ShippingFee ?? 0).ToString("#,##0")) đ</span>
                        </div>
                        <div class="border-top w-100 my-2" style="max-width: 300px;"></div>
                        <div class="d-flex justify-content-between w-100" style="max-width: 300px;">
                            <span class="fw-bold text-dark">Tổng cộng</span>
                            <span class="fw-bold text-danger fs-5">@((Model.TotalAmount ?? 0).ToString("#,##0")) đ</span>
                        </div>
                    </div>
                    
                    @if(isCompleted) {
                         <div class="text-end mt-4">
                             <a href="#" class="btn btn-danger rounded-pill px-4">Mua lại</a>
                         </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
