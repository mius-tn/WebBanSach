@model WedBanSach.ViewModels.NotificationDetailViewModel
@using WedBanSach.Helpers
@{
    ViewData["Title"] = "Chi tiết thông báo";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Navigation -->
            <div class="mb-4">
                <a asp-action="Notifications" class="text-decoration-none text-muted">
                    <i class="bi bi-arrow-left me-1"></i> Quay lại danh sách
                </a>
            </div>

            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-white py-4 px-4 border-bottom">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-circle d-flex align-items-center justify-content-center @(GetBgColorClass(Model.Notification.Type))" style="width: 50px; height: 50px;">
                            <i class="bi @(GetIconClass(Model.Notification.Type)) fs-4"></i>
                        </div>
                        <div>
                            <h4 class="mb-1 fw-bold">@Model.Notification.Title</h4>
                            <span class="text-muted small">
                                <i class="bi bi-clock me-1"></i> @Model.Notification.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <p class="text-secondary fs-6 mb-4">@Model.Notification.Message</p>

                    @if (Model.Order != null)
                    {
                        var order = Model.Order;
                        <div class="bg-light rounded-4 p-4 mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold m-0">Thông tin đơn hàng #@order.OrderID</h5>
                                <span class="badge @(GetStatusClass(order.OrderStatus)) px-3 py-2 rounded-pill">
                                    @(order.OrderStatus == "Completed" ? "Giao hàng thành công" :
                                      order.OrderStatus == "Cancelled" ? "Đã hủy" :
                                      order.OrderStatus == "Shipping" ? "Đang giao hàng" :
                                      order.OrderStatus == "Pending" ? "Chờ xử lý" : order.OrderStatus)
                                </span>
                            </div>

                            <!-- Receiver Info -->
                            <div class="mb-4">
                                <h6 class="text-uppercase text-muted x-small fw-bold mb-2">Người nhận</h6>
                                <p class="mb-1 fw-bold">@order.User.FullName</p>
                                <p class="mb-1 small text-muted">@order.ShippingAddress</p>
                                <p class="mb-0 small text-muted">@order.User.Phone</p>
                            </div>
                            
                            <!-- Items -->
                            <div class="table-responsive mb-3">
                                <table class="table table-borderless align-middle">
                                    <thead class="text-secondary small">
                                        <tr>
                                            <th>Sản phẩm</th>
                                            <th class="text-center">SL</th>
                                            <th class="text-end">Đơn giá</th>
                                            <th class="text-end">Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var detail in order.OrderDetails)
                                        {
                                            <tr>
                                                <td style="min-width: 200px;">
                                                    <div class="d-flex gap-2 align-items-center">
                                                        <img src="@(detail.Book.BookImages.FirstOrDefault()?.ImageUrl ?? "/images/default-book.png")" 
                                                             class="rounded object-fit-cover" width="40" height="60" />
                                                        <div>
                                                            <p class="mb-0 small fw-bold text-truncate" style="max-width: 180px;">@detail.Book.Title</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="text-center small">x @detail.Quantity</td>
                                                <td class="text-end small">@((detail.UnitPrice ?? 0).ToString("N0")) đ</td>
                                                <td class="text-end fw-bold small">@((detail.UnitPrice * detail.Quantity ?? 0).ToString("N0")) đ</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <hr>

                            <!-- Summary -->
                            <div class="row items-center">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <p class="mb-1 small text-muted">Phương thức thanh toán</p>
                                    <p class="fw-bold m-0"><i class="bi bi-credit-card me-1"></i> @(order.PaymentMethod == "Bank Transfer" ? "Chuyển khoản" : order.PaymentMethod)</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <p class="mb-1 small text-muted">Phí vận chuyển: <span class="fw-bold text-dark">@((order.ShippingFee ?? 0).ToString("N0")) đ</span></p>
                                    <h5 class="fw-bold text-pink m-0">Tổng cộng: @((order.TotalAmount ?? 0).ToString("N0")) đ</h5>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="card-footer bg-white p-3 text-center">
                    <a asp-action="Notifications" class="btn btn-outline-secondary rounded-pill px-4">Đóng</a>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetBgColorClass(string? type) {
        return type == "Order" ? "bg-warning-subtle text-warning-emphasis" :
               type == "Promotion" ? "bg-danger-subtle text-danger" :
               "bg-primary-subtle text-primary";
    }

    string GetIconClass(string? type) {
        return type == "Order" ? "bi-box-seam" :
               type == "Promotion" ? "bi-tag" :
               "bi-info-circle";
    }

    string GetStatusClass(string? status) {
        return status == "Completed" ? "bg-success" :
               status == "Cancelled" ? "bg-danger" :
               status == "Shipping" ? "bg-info" :
               "bg-warning text-dark";
    }
}
